{% extends 'user/user_base.html' %}
{% block title %}Vendor Wallet - {{ settings['site_name'] }}{% endblock %}
{% block user_content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold text-gray-900 ">Account Wallet</h1>
    <p class="mb-6 opacity-70">Withdraw your funds from sales anytime, directly into your cryptocurrency wallet.</p>

    <!-- Wallet Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 max-w-screen-md">
        <div class="bg-white p-6 rounded-lg shadow-md border">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Total Sales</h2>
            <p class="text-2xl text-gray-900">${{ "%.2f"|format(total_sales) }}</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Wallet Balance</h2>
            <p class="text-2xl text-gray-900">${{ "%.2f"|format(balance_usd) }}</p>
        </div>
    </div>

    <!-- Withdrawal Form -->
    <div class="bg-white p-6 rounded-lg shadow-md border mb-6 max-w-screen-md">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Withdraw Funds</h2>
        <form method="POST" action="{{ url_for('wallet.withdraw') }}" id="withdraw-form">
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Amount (USD)</label>
                <input type="number" name="amount_usd" step="0.01" min="0.01" max="{{ balance_usd }}" 
                       class="w-full py-2 px-4 rounded-md border border-gray-300 focus:ring-2 focus:ring-yellow-400 focus:outline-none" 
                       required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Cryptocurrency</label>
                <select name="crypto_currency" id="crypto-currency" 
                        class="w-full py-2 px-4 rounded-md border border-gray-300 focus:ring-2 focus:ring-yellow-400 focus:outline-none" 
                        required>
                    <option value="BTC">Bitcoin (BTC)</option>
                    <option value="XMR">Monero (XMR)</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Wallet Address</label>
                <input type="text" name="wallet_address" 
                       class="w-full py-2 px-4 rounded-md border border-gray-300 focus:ring-2 focus:ring-yellow-400 focus:outline-none" 
                       required>
            </div>
            <div class="mb-4">
                <p class="text-gray-600">Estimated Conversion:</p>
                <p id="crypto-conversion" class="text-gray-900 font-semibold">Select amount and currency to see conversion</p>
            </div>
            <button type="submit" 
                    class="bg-yellow-400 text-gray-900 font-semibold py-2 px-4 rounded-md hover:bg-yellow-500 transition duration-200">
                Submit Withdrawal
            </button>
        </form>
    </div>

    <!-- Recent Withdrawals -->
    <div class="bg-white p-6 rounded-lg shadow-md border max-w-screen-md">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Recent Withdrawals</h2>
        {% if withdrawals %}
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                    <tr class="border-b">
                        <th class="py-2 px-4">Date</th>
                        <th class="py-2 px-4">Amount (USD)</th>
                        <th class="py-2 px-4">Crypto</th>
                        <th class="py-2 px-4">Crypto Amount</th>
                        <th class="py-2 px-4">Wallet Address</th>
                        <th class="py-2 px-4">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for w in withdrawals %}
                    <tr class="border-b">
                        <td class="py-2 px-4">{{ w['requested_at'] }}</td>
                        <td class="py-2 px-4">${{ "%.2f"|format(w['amount_usd']) }}</td>
                        <td class="py-2 px-4">{{ w['crypto_currency'] }}</td>
                        <td class="py-2 px-4">{{ "%.6f"|format(w['crypto_amount']) }}</td>
                        <td class="py-2 px-4">{{ w['wallet_address']|truncate(20, True, '...') }}</td>
                        <td class="py-2 px-4">{{ w['status']|capitalize }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-600">No recent withdrawals.</p>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("withdraw-form");
        const amountInput = document.querySelector("input[name='amount_usd']");
        const cryptoSelect = document.getElementById("crypto-currency");
        const conversionDisplay = document.getElementById("crypto-conversion");

        // Crypto prices from backend
        const btcPrice = {{ btc_price|tojson }};
        const xmrPrice = {{ xmr_price|tojson }};

        function updateConversion() {
            const amount = parseFloat(amountInput.value) || 0;
            const currency = cryptoSelect.value;
            let cryptoAmount = 0;
            if (currency === "BTC" && btcPrice) {
                cryptoAmount = amount / btcPrice;
                conversionDisplay.textContent = `${cryptoAmount.toFixed(6)} BTC`;
            } else if (currency === "XMR" && xmrPrice) {
                cryptoAmount = amount / xmrPrice;
                conversionDisplay.textContent = `${cryptoAmount.toFixed(6)} XMR`;
            } else {
                conversionDisplay.textContent = "Price unavailable";
            }
        }

        amountInput.addEventListener("input", updateConversion);
        cryptoSelect.addEventListener("change", updateConversion);
        updateConversion(); // Initial call
    });
</script>
{% endblock %}